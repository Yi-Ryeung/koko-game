<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koko Leaf Dash (Mobile + Phantom)</title>
  <style>
    html,body { height:100%; margin:0; font-family: 'Helvetica', Arial, sans-serif; -webkit-tap-highlight-color: transparent;}
    #app { display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px; box-sizing:border-box; background: #e8f0ea; min-height:100vh; }
    canvas { border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.18); touch-action: none; background: #cfe7d0; width:100%; max-width:900px; height:auto; display:block; }
    .hud { width:100%; max-width:900px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .left { display:flex; gap:8px; align-items:center; }
    button { padding:10px 12px; border-radius:10px; border:0; background:white; box-shadow: 0 3px 8px rgba(0,0,0,0.12); font-weight:600; }
    .small { font-size:13px; padding:8px 10px; }
    .note { font-size:12px; color:#444; max-width:900px; text-align:left; }
    #addr { font-size:12px; color:#0b7; word-break:break-all; }
  </style>
</head>
<body>
  <div id="app">
    <h2>ğŸ¨ Koko Leaf Dash</h2>

    <div class="hud">
      <div class="left">
        <div id="scoreBox">Score: 0</div>
        <div style="width:12px;"></div>
        <div id="cocoBox">COCO: 0</div>
      </div>

      <div style="display:flex; gap:8px;">
        <button id="connectBtn" class="small">Connect Phantom</button>
        <button id="signBtn" class="small" disabled>Sign Redemption</button>
      </div>
    </div>

    <canvas id="game" width="900" height="520"></canvas>

    <div class="note">
      <div id="addr">ì§€ê°‘: ë¯¸ì—°ê²°</div>
      <p>ì¡°ì‘: í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì½”ì½”ê°€ í„°ì¹˜ ì§€ì ìœ¼ë¡œ ì²œì²œíˆ ì´ë™í•©ë‹ˆë‹¤. ìœ ì¹¼ë¦½íˆ¬ìŠ¤ ìì„ ë°›ì•„ ì ìˆ˜ë¥¼ ì˜¬ë¦¬ì„¸ìš”. (10ì /ì) <strong>100ì  = 1 COCO</strong></p>
      <p><strong>í•¸ë“œí°ì—ì„œ ì§€ê°‘ ì—°ê²°í•˜ë ¤ë©´ Phantom ì•±ì˜ ë‚´ì¥ ë¸Œë¼ìš°ì €ë¡œ ì´ í˜ì´ì§€ë¥¼ ì—¬ì„¸ìš”.</strong></p>
    </div>
  </div>

<script>
(() => {
  // ì„¤ì •
  const POINT_PER_LEAF = 10;
  const CONVERSION_RATE = 100; // pts -> 1 COCO
  const LEAF_SPAWN_MS = 900;

  // ìš”ì†Œ
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreBox = document.getElementById('scoreBox');
  const cocoBox = document.getElementById('cocoBox');
  const connectBtn = document.getElementById('connectBtn');
  const signBtn = document.getElementById('signBtn');
  const addrEl = document.getElementById('addr');

  // ë°˜ì‘í˜• í¬ê¸° (í™”ë©´ ë„ˆë¹„ ë”°ë¼)
  function fitCanvas() {
    const maxW = Math.min(window.innerWidth - 20, 900);
    const scale = maxW / 900;
    canvas.style.width = Math.round(900 * scale) + 'px';
    canvas.style.height = Math.round(520 * scale) + 'px';
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  // ì´ë¯¸ì§€ ë¡œë“œ
  const IMG_BG = new Image();
  const IMG_KOKO = new Image();
  const IMG_LEAF = new Image();
  IMG_BG.src = 'background.png';
  IMG_KOKO.src = 'koko.png';
  IMG_LEAF.src = 'leaf.png';

  // ê²Œì„ ìƒíƒœ
  let score = 0;
  let leaves = [];
  let lastSpawn = 0;
  let lastTime = performance.now();

  // ì½”ì½” ê°ì²´
  const koala = { x: 450, y: 400, w: 140, h: 140, targetX: 450 };

  // ì…ë ¥: í„°ì¹˜/í´ë¦­ -> ëª©í‘œ X ì„¤ì •
  function onPointer(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
    const x = (clientX - rect.left) * (900 / rect.width);
    koala.targetX = x;
  }
  canvas.addEventListener('pointerdown', onPointer);
  canvas.addEventListener('touchstart', onPointer);

  // ì ìƒì„±
  function spawnLeaf() {
    const x = 40 + Math.random() * (900 - 80);
    const size = 36 + Math.random() * 36;
    leaves.push({ x, y: -30, vy: 80 + Math.random() * 80, size, wobble: Math.random()*6 });
  }

  // ì¶©ëŒ ê²€ì‚¬
  function collide(aX, aY, aR, bX, bY, bR) {
    const dx = aX - bX;
    const dy = aY - bY;
    return dx*dx + dy*dy <= (aR + bR)*(aR + bR);
  }

  // ë Œë”/ì—…ë°ì´íŠ¸ ë£¨í”„
  function loop(now) {
    const dt = Math.min(0.05, (now - lastTime)/1000);
    lastTime = now;

    // ìŠ¤í° íƒ€ì´ë°
    lastSpawn += dt*1000;
    if (lastSpawn >= LEAF_SPAWN_MS) { lastSpawn = 0; spawnLeaf(); }

    // ì—…ë°ì´íŠ¸
    // ì½”ì½” ë¶€ë“œëŸ½ê²Œ ì´ë™
    koala.x += (koala.targetX - koala.x) * Math.min(1, 6*dt);

    // ì ì´ë™
    for (let i = leaves.length - 1; i >= 0; i--) {
      const lf = leaves[i];
      lf.y += lf.vy * dt;
      lf.x += Math.sin((lf.wobble += dt*6)) * 20 * dt;

      // ì¶©ëŒ
      if (collide(koala.x, koala.y, 54, lf.x, lf.y, lf.size * 0.6)) {
        score += POINT_PER_LEAF;
        leaves.splice(i,1);
        updateHUD();
        continue;
      }
      // ë°”ë‹¥ ì§€ë‚˜ì¹˜ë©´ ì œê±°
      if (lf.y - lf.size > 520) {
        leaves.splice(i,1);
      }
    }

    // ê·¸ë¦¬ê¸° (ë…¼ë¦¬ ì¢Œí‘œ 900x520)
    ctx.clearRect(0,0,900,520);
    // ë°°ê²½
    if (IMG_BG.complete) ctx.drawImage(IMG_BG, 0, 0, 900, 520);
    else { ctx.fillStyle = '#d7f0d8'; ctx.fillRect(0,0,900,520); }

    // ì
    for (const lf of leaves) {
      ctx.save();
      ctx.translate(lf.x, lf.y);
      ctx.rotate(Math.sin(lf.wobble) * 0.4);
      if (IMG_LEAF.complete) ctx.drawImage(IMG_LEAF, -lf.size/2, -lf.size/2, lf.size, lf.size);
      else {
        ctx.fillStyle = '#2ea44f';
        ctx.beginPath(); ctx.ellipse(0,0,lf.size/2,lf.size/3,0,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }

    // ì½”ì½” ê·¸ë¦¬ê¸°
    if (IMG_KOKO.complete) ctx.drawImage(IMG_KOKO, koala.x - koala.w/2, koala.y - koala.h/2, koala.w, koala.h);
    else {
      ctx.fillStyle='#9aa2b0';
      ctx.beginPath(); ctx.arc(koala.x, koala.y, 60,0,2*Math.PI); ctx.fill();
    }

    requestAnimationFrame(loop);
  }

  function updateHUD() {
    scoreBox.innerText = 'Score: ' + score;
    cocoBox.innerText = 'COCO: ' + Math.floor(score / CONVERSION_RATE);
  }

  // Phantom wallet ì—°ê²°/ì„œëª…
  let connected = false;
  connectBtn.addEventListener('click', async () => {
    if (!window.solana) {
      alert('Phantomì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë°”ì¼ì—ì„œëŠ” Phantom ì•± ë‚´ ë¸Œë¼ìš°ì €ë¡œ ì´ í˜ì´ì§€ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.');
      return;
    }
    try {
      const resp = await window.solana.connect();
      connected = true;
      connectBtn.innerText = 'Connected âœ“';
      connectBtn.disabled = true;
      signBtn.disabled = false;
      addrEl.innerText = 'ì§€ê°‘: ' + (window.solana.publicKey ? window.solana.publicKey.toString() : (resp?.publicKey?.toString()||'ì—°ê²°ë¨'));
    } catch (err) {
      console.error(err);
      alert('ì§€ê°‘ ì—°ê²° ì·¨ì†Œë¨');
    }
  });

  signBtn.addEventListener('click', async () => {
    if (!connected || !window.solana) { alert('ì§€ê°‘ì„ ì—°ê²°í•˜ì„¸ìš”'); return; }
    try {
      const publicKey = window.solana.publicKey?.toString();
      const cocoAmount = Math.floor(score / CONVERSION_RATE);
      if (cocoAmount <= 0) { alert('êµí™˜ ê°€ëŠ¥í•œ COCOê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const msg = `KokoLeafRedeem\\naddress=${publicKey}\\nscore=${score}\\nCOCO=${cocoAmount}\\ntime=${new Date().toISOString()}`;
      const encoded = new TextEncoder().encode(msg);
      // Phantom signMessage (may return {signature, publicKey})
      const signed = await window.solana.signMessage(encoded, 'utf8');
      // signed.signature could be Uint8Array or Array
      const sigArr = signed?.signature || signed;
      const sigU8 = sigArr instanceof Uint8Array ? sigArr : new Uint8Array(sigArr);
      const base64 = btoa(String.fromCharCode(...sigU8));
      alert('ì„œëª… ì™„ë£Œ (base64):\\n' + base64);
    } catch (err) {
      console.error(err);
      alert('ì„œëª… ì‹¤íŒ¨: ' + (err?.message || err));
    }
  });

  // ì´ˆê¸° HUD
  updateHUD();

  // ì‹œì‘ ë£¨í”„
  lastTime = performance.now();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
