<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koko Leaf Dash</title>
  <style>
    html,body { height:100%; margin:0; font-family:'Helvetica',Arial,sans-serif; -webkit-tap-highlight-color:transparent;}
    #app { display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px; box-sizing:border-box; background:#e8f0ea; min-height:100vh;}
    canvas { border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.18); touch-action:none; background:#cfe7d0; width:100%; max-width:900px; height:auto; display:block;}
    .hud { width:100%; max-width:900px; display:flex; justify-content:space-between; gap:8px; align-items:center;}
    .left { display:flex; gap:8px; align-items:center;}
    button { padding:10px 12px; border-radius:10px; border:0; background:white; box-shadow:0 3px 8px rgba(0,0,0,0.12); font-weight:600;}
    .small { font-size:13px; padding:8px 10px;}
    .note { font-size:12px; color:#444; max-width:900px; text-align:left;}
    #addr { font-size:12px; color:#0b7; word-break:break-all;}
    #overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .game-over { pointer-events:auto; background:rgba(0,0,0,0.55); color:white; padding:20px; border-radius:12px; text-align:center; width:80%; max-width:360px;}
  </style>
</head>
<body>
  <div id="app">
    <h2>üê® Koko Leaf Dash</h2>

    <div class="hud">
      <div class="left">
        <div id="scoreBox">Score: 0</div>
        <div style="width:12px;"></div>
        <div id="kokoBox">KOKO: 0</div>
        <div style="width:12px;"></div>
        <div id="missBox">Misses: 0 / 2</div>
      </div>

      <div style="display:flex; gap:8px;">
        <button id="connectBtn" class="small">Connect Wallet</button>
        <button id="buyBtn" class="small" disabled>Buy Item (0.005 SOL)</button>
        <button id="claimBtn" class="small" disabled>Claim KOKO</button>
      </div>
    </div>

    <canvas id="game" width="900" height="520"></canvas>

    <div class="note">
      <div id="addr">Wallet: not connected</div>
      <p>Tap anywhere to move Koko. Catch eucalyptus leaves to earn <strong>10 points</strong> each.  
         When your score reaches <strong>100 points</strong>, you can claim <strong>1 KOKO token</strong>.</p>
      <p><strong>Tip:</strong> Open this page inside the <strong>Phantom app browser</strong> on mobile to connect your wallet.</p>
      <p>Note: Actual KOKO token transfers are made by the reward wallet (server or admin). This game only creates a signed claim request.</p>
    </div>

    <div id="overlay"></div>
  </div>

<script>
(() => {
  // ---------- CONFIG ----------
  const SELLER_ADDRESS = "SELLER_PUBLIC_KEY_HERE"; // Replace with your seller wallet address
  const ITEM_PRICE_SOL = 0.005;                    // <-- updated to 0.005 SOL
  const REWARD_SERVER_ENDPOINT = "";               // Optional: backend endpoint
  const KOKO_PER_THRESHOLD = 1;
  const POINT_PER_LEAF = 10;
  const CONVERSION_RATE = 100;
  const LEAF_SPAWN_MS = 900;

  // Elements
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreBox = document.getElementById('scoreBox');
  const kokoBox = document.getElementById('kokoBox');
  const connectBtn = document.getElementById('connectBtn');
  const buyBtn = document.getElementById('buyBtn');
  const claimBtn = document.getElementById('claimBtn');
  const addrEl = document.getElementById('addr');
  const missBox = document.getElementById('missBox');
  const overlay = document.getElementById('overlay');

  // Responsive canvas
  function fitCanvas(){
    const maxW=Math.min(window.innerWidth-20,900);
    const scale=maxW/900;
    canvas.style.width=Math.round(900*scale)+'px';
    canvas.style.height=Math.round(520*scale)+'px';
  }
  window.addEventListener('resize',fitCanvas);
  fitCanvas();

  // Images
  const IMG_BG=new Image(), IMG_KOKO=new Image(), IMG_LEAF=new Image();
  IMG_BG.src='background.png'; IMG_KOKO.src='koko.png'; IMG_LEAF.src='leaf.png';

  // Game state
  let score=0, leaves=[], lastSpawn=0, lastTime=performance.now();
  let misses=0, gameOverFlag=false, connected=false, lastRewardedThreshold=0;
  const koko={x:450,y:400,w:140,h:140,targetX:450};

  function onPointer(e){
    if(gameOverFlag)return;
    const rect=canvas.getBoundingClientRect();
    const x=((e.touches?e.touches[0].clientX:e.clientX)-rect.left)*(900/rect.width);
    koko.targetX=x;
  }
  canvas.addEventListener('pointerdown',onPointer);
  canvas.addEventListener('touchstart',onPointer);

  function spawnLeaf(){
    const x=40+Math.random()*(900-80);
    const size=36+Math.random()*36;
    leaves.push({x,y:-30,vy:80+Math.random()*80,size,wobble:Math.random()*6});
  }

  function collide(ax,ay,ar,bx,by,br){
    const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy<=(ar+br)*(ar+br);
  }

  function updateHUD(){
    scoreBox.innerText='Score: '+score;
    kokoBox.innerText='KOKO: '+Math.floor(score/CONVERSION_RATE);
    missBox.innerText='Misses: '+misses+' / 2';
    claimBtn.disabled=!(score>=CONVERSION_RATE);
  }

  function gameOver(){
    gameOverFlag=true;
    overlay.innerHTML=`<div class="game-over"><h3>Game Over</h3><p>You missed 2 leaves.</p><p>Final Score: ${score}</p><button id="restartBtn" class="small">Restart</button></div>`;
    document.getElementById('restartBtn').onclick=restartGame;
  }

  function restartGame(){
    score=0;leaves=[];lastSpawn=0;misses=0;gameOverFlag=false;overlay.innerHTML='';
    lastTime=performance.now();requestAnimationFrame(loop);updateHUD();
  }

  function loop(now){
    if(gameOverFlag)return;
    const dt=Math.min(0.05,(now-lastTime)/1000);lastTime=now;
    lastSpawn+=dt*1000;if(lastSpawn>=LEAF_SPAWN_MS){lastSpawn=0;spawnLeaf();}
    koko.x+=(koko.targetX-koko.x)*Math.min(1,6*dt);
    for(let i=leaves.length-1;i>=0;i--){
      const lf=leaves[i];lf.y+=lf.vy*dt;lf.x+=Math.sin((lf.wobble+=dt*6))*20*dt;
      if(collide(koko.x,koko.y,54,lf.x,lf.y,lf.size*0.6)){
        score+=POINT_PER_LEAF;leaves.splice(i,1);updateHUD();checkReward();continue;
      }
      if(lf.y-lf.size>520){leaves.splice(i,1);misses++;updateHUD();if(misses>=2){gameOver();return;}}
    }
    ctx.clearRect(0,0,900,520);
    if(IMG_BG.complete)ctx.drawImage(IMG_BG,0,0,900,520);else{ctx.fillStyle='#d7f0d8';ctx.fillRect(0,0,900,520);}
    for(const lf of leaves){ctx.save();ctx.translate(lf.x,lf.y);ctx.rotate(Math.sin(lf.wobble)*0.4);
      if(IMG_LEAF.complete)ctx.drawImage(IMG_LEAF,-lf.size/2,-lf.size/2,lf.size,lf.size);
      else{ctx.fillStyle='#2ea44f';ctx.beginPath();ctx.ellipse(0,0,lf.size/2,lf.size/3,0,0,Math.PI*2);ctx.fill();}
      ctx.restore();}
    if(IMG_KOKO.complete)ctx.drawImage(IMG_KOKO,koko.x-koko.w/2,koko.y-koko.h/2,koko.w,koko.h);
    else{ctx.fillStyle='#9aa2b0';ctx.beginPath();ctx.arc(koko.x,koko.y,60,0,2*Math.PI);ctx.fill();}
    requestAnimationFrame(loop);
  }

  function checkReward(){
    const current=Math.floor(score/CONVERSION_RATE);
    if(current>lastRewardedThreshold){lastRewardedThreshold=current;alert(`You can claim ${current*KOKO_PER_THRESHOLD} KOKO token(s)! Press "Claim KOKO".`);}
  }

  connectBtn.onclick=async()=>{
    if(!window.solana){alert('Phantom wallet not detected.');return;}
    try{const r=await window.solana.connect();connected=true;
      connectBtn.innerText='Connected ‚úì';connectBtn.disabled=true;
      buyBtn.disabled=false;claimBtn.disabled=!(score>=CONVERSION_RATE);
      addrEl.innerText='Wallet: '+(window.solana.publicKey?.toString()||r?.publicKey?.toString()||'connected');
    }catch(e){alert('Wallet connection canceled.');}
  };

  buyBtn.onclick=async()=>{
    if(!connected||!window.solana){alert('Connect your wallet first.');return;}
    try{
      const pk=window.solana.publicKey;
      const lamports=Math.round(ITEM_PRICE_SOL*1e9);
      const to=new solanaWeb3.PublicKey(SELLER_ADDRESS);
      const tx=new solanaWeb3.Transaction().add(solanaWeb3.SystemProgram.transfer({fromPubkey:pk,toPubkey:to,lamports}));
      tx.feePayer=pk;
      const {blockhash}=await(new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'))).getLatestBlockhash();
      tx.recentBlockhash=blockhash;
      const signed=await window.solana.signTransaction(tx);
      const raw=signed.serialize();
      const conn=new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const sig=await conn.sendRawTransaction(raw);
      await conn.confirmTransaction(sig,'confirmed');
      alert('Item purchased! Tx: '+sig);
    }catch(e){alert('Purchase failed: '+(e?.message||e));}
  };

  claimBtn.onclick=async()=>{
    if(!connected||!window.solana){alert('Connect wallet first.');return;}
    try{
      const pub=window.solana.publicKey?.toString();
      const amt=Math.floor(score/CONVERSION_RATE)*KOKO_PER_THRESHOLD;
      if(amt<=0){alert('No KOKO available yet.');return;}
      const msg=`KokoLeafClaim\naddress=${pub}\nscore=${score}\nKOKO=${amt}\ntime=${new Date().toISOString()}`;
      const enc=new TextEncoder().encode(msg);
      const signed=await window.solana.signMessage(enc,'utf8');
      const sigU8=new Uint8Array(signed.signature||signed);
      const base64=btoa(String.fromCharCode(...sigU8));
      const obj={publicKey:pub,score,kokoAmount:amt,message:msg,signature:base64};
      if(REWARD_SERVER_ENDPOINT){
        try{
          const res=await fetch(REWARD_SERVER_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
          if(!res.ok)throw new Error('Server '+res.status);
          alert('Claim sent!');}
        catch(e){copy(JSON.stringify(obj));alert('Server failed. Claim copied.');}
      }else{copy(JSON.stringify(obj));alert('Claim copied. Send to admin for KOKO.');}
      lastRewardedThreshold=Math.floor(score/CONVERSION_RATE);updateHUD();
    }catch(e){alert('Claim failed: '+(e?.message||e));}
  };

  function copy(t){
    if(navigator.clipboard)navigator.clipboard.writeText(t).catch(()=>fallbackCopy(t));else fallbackCopy(t);
  }
  function fallbackCopy(t){const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();}

  updateHUD();lastTime=performance.now();requestAnimationFrame(loop);
})();
</script>
<script src="https://unpkg.com/@solana/web3.js@1.76.1/lib/index.iife.js"></script>
</body>
</html>
