<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koko Leaf Dash (Mobile + Phantom)</title>
  <style>
    html,body { height:100%; margin:0; font-family: 'Helvetica', Arial, sans-serif; -webkit-tap-highlight-color: transparent;}
    #app { display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px; box-sizing:border-box; background: #e8f0ea; min-height:100vh; }
    canvas { border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.18); touch-action: none; background: #cfe7d0; width:100%; max-width:900px; height:auto; display:block; }
    .hud { width:100%; max-width:900px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .left { display:flex; gap:8px; align-items:center; }
    button { padding:10px 12px; border-radius:10px; border:0; background:white; box-shadow: 0 3px 8px rgba(0,0,0,0.12); font-weight:600; }
    .small { font-size:13px; padding:8px 10px; }
    .note { font-size:12px; color:#444; max-width:900px; text-align:left; }
    #addr { font-size:12px; color:#0b7; word-break:break-all; }
    #overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }
    .game-over {
      pointer-events:auto;
      background: rgba(0,0,0,0.55);
      color:white;
      padding:20px;
      border-radius:12px;
      text-align:center;
      width:80%;
      max-width:360px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h2>ğŸ¨ Koko Leaf Dash</h2>

    <div class="hud">
      <div class="left">
        <div id="scoreBox">Score: 0</div>
        <div style="width:12px;"></div>
        <div id="cocoBox">COCO: 0</div>
        <div style="width:12px;"></div>
        <div id="missBox">Misses: 0 / 2</div>
      </div>

      <div style="display:flex; gap:8px;">
        <button id="connectBtn" class="small">Connect Phantom</button>
        <button id="buyBtn" class="small" disabled>Buy Item (0.1 SOL)</button>
        <button id="claimBtn" class="small" disabled>Claim KOKO</button>
      </div>
    </div>

    <canvas id="game" width="900" height="520"></canvas>

    <div class="note">
      <div id="addr">ì§€ê°‘: ë¯¸ì—°ê²°</div>
      <p>ì¡°ì‘: í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì½”ì½”ê°€ í„°ì¹˜ ì§€ì ìœ¼ë¡œ ì²œì²œíˆ ì´ë™í•©ë‹ˆë‹¤. ìœ ì¹¼ë¦½íˆ¬ìŠ¤ ìì„ ë°›ì•„ ì ìˆ˜ë¥¼ ì˜¬ë¦¬ì„¸ìš”. (10ì /ì) <strong>100ì  = 1 COCO (í´ë ˆì„ í•„ìš”)</strong></p>
      <p><strong>í•¸ë“œí°ì—ì„œ ì§€ê°‘ ì—°ê²°í•˜ë ¤ë©´ Phantom ì•±ì˜ ë‚´ì¥ ë¸Œë¼ìš°ì €ë¡œ ì´ í˜ì´ì§€ë¥¼ ì—¬ì„¸ìš”.</strong></p>
      <p>ì°¸ê³ : COCO í† í°(ì‹¤ì œ SPL í† í°) ì§€ê¸‰ì€ ê²Œì„ í´ë¼ì´ì–¸íŠ¸ê°€ ì•„ë‹Œ ë³´ìƒ ì§€ê°‘(ì„œë²„ ë˜ëŠ” ìš´ì˜ì)ì´ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ê²Œì„ì€ 'í´ë ˆì„ ìš”ì²­' ì„œëª…ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
    </div>

    <div id="overlay"></div>
  </div>

<script>
(() => {
  // ---------- ì„¤ì • (í•„ìˆ˜ë¡œ êµì²´) ----------
  const SELLER_ADDRESS = "SELLER_PUBLIC_KEY_HERE"; // ì˜ˆ: "Fj...ABC" - ì•„ì´í…œ íŒë§¤ì ì£¼ì†Œë¡œ êµì²´
  const ITEM_PRICE_SOL = 0.1; // ì•„ì´í…œ ê°€ê²© (SOL)
  const REWARD_SERVER_ENDPOINT = ""; // ìë™ ì²˜ë¦¬ìš© ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆë‹¤ë©´ ì…ë ¥ (ì˜ˆ: https://yourserver.com/reward)
  const KOKO_PER_THRESHOLD = 1; // 100ì  ë‹¹ ì§€ê¸‰í•  í† í° ê°œìˆ˜ (ì •ì±…)
  const POINT_PER_LEAF = 10;
  const CONVERSION_RATE = 100; // pts -> 1 COCO
  const LEAF_SPAWN_MS = 900;

  // ìš”ì†Œ
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreBox = document.getElementById('scoreBox');
  const cocoBox = document.getElementById('cocoBox');
  const connectBtn = document.getElementById('connectBtn');
  const buyBtn = document.getElementById('buyBtn');
  const claimBtn = document.getElementById('claimBtn');
  const addrEl = document.getElementById('addr');
  const missBox = document.getElementById('missBox');
  const overlay = document.getElementById('overlay');

  // ë°˜ì‘í˜• ìº”ë²„ìŠ¤
  function fitCanvas() {
    const maxW = Math.min(window.innerWidth - 20, 900);
    const scale = maxW / 900;
    canvas.style.width = Math.round(900 * scale) + 'px';
    canvas.style.height = Math.round(520 * scale) + 'px';
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  // ì´ë¯¸ì§€ ë¡œë“œ
  const IMG_BG = new Image();
  const IMG_KOKO = new Image();
  const IMG_LEAF = new Image();
  IMG_BG.src = 'background.png';
  IMG_KOKO.src = 'koko.png';
  IMG_LEAF.src = 'leaf.png';

  // ê²Œì„ ìƒíƒœ
  let score = 0;
  let leaves = [];
  let lastSpawn = 0;
  let lastTime = performance.now();
  let misses = 0;
  let gameOverFlag = false;
  let connected = false;
  let lastRewardedThreshold = 0; // ì¤‘ë³µ ë³´ìƒ ë°©ì§€

  // ì½”ì½” ê°ì²´
  const koala = { x: 450, y: 400, w: 140, h: 140, targetX: 450 };

  // ì…ë ¥: í„°ì¹˜/í´ë¦­ -> ëª©í‘œ X ì„¤ì • (ë¹„í™œì„±í™” ìƒíƒœ ì²´í¬ í¬í•¨)
  function onPointer(e) {
    if (gameOverFlag) return;
    const rect = canvas.getBoundingClientRect();
    const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
    const x = (clientX - rect.left) * (900 / rect.width);
    koala.targetX = x;
  }
  canvas.addEventListener('pointerdown', onPointer);
  canvas.addEventListener('touchstart', onPointer);

  // ì ìƒì„±
  function spawnLeaf() {
    const x = 40 + Math.random() * (900 - 80);
    const size = 36 + Math.random() * 36;
    leaves.push({ x, y: -30, vy: 80 + Math.random() * 80, size, wobble: Math.random()*6 });
  }

  // ì¶©ëŒ ê²€ì‚¬ (ì› ê·¼ì‚¬)
  function collide(aX, aY, aR, bX, bY, bR) {
    const dx = aX - bX;
    const dy = aY - bY;
    return dx*dx + dy*dy <= (aR + bR)*(aR + bR);
  }

  // HUD ì—…ë°ì´íŠ¸
  function updateHUD() {
    scoreBox.innerText = 'Score: ' + score;
    cocoBox.innerText = 'COCO: ' + Math.floor(score / CONVERSION_RATE);
    missBox.innerText = 'Misses: ' + misses + ' / 2';
    // claim ë²„íŠ¼ì€ ì ìˆ˜ê¸°ì¤€ í™œì„±í™”
    claimBtn.disabled = !(score >= CONVERSION_RATE);
  }

  // ê²Œì„ì˜¤ë²„ ì²˜ë¦¬
  function gameOver() {
    gameOverFlag = true;
    // ì˜¤ë²„ë ˆì´ í‘œì‹œ
    overlay.innerHTML = `
      <div class="game-over">
        <h3>ê²Œì„ ì˜¤ë²„</h3>
        <p>ìì‚¬ê·€ë¥¼ 2ë²ˆ ë†“ì³¤ìŠµë‹ˆë‹¤.</p>
        <p>ì ìˆ˜: ${score}</p>
        <button id="restartBtn" class="small">ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    `;
    const restartBtn = document.getElementById('restartBtn');
    restartBtn.addEventListener('click', restartGame);
  }

  function restartGame() {
    // ì´ˆê¸°í™”
    score = 0;
    leaves = [];
    lastSpawn = 0;
    misses = 0;
    gameOverFlag = false;
    overlay.innerHTML = '';
    lastTime = performance.now();
    requestAnimationFrame(loop);
    updateHUD();
  }

  // ë Œë”/ì—…ë°ì´íŠ¸ ë£¨í”„
  function loop(now) {
    if (gameOverFlag) return;
    const dt = Math.min(0.05, (now - lastTime)/1000);
    lastTime = now;

    // ìŠ¤í° íƒ€ì´ë°
    lastSpawn += dt*1000;
    if (lastSpawn >= LEAF_SPAWN_MS) { lastSpawn = 0; spawnLeaf(); }

    // ì—…ë°ì´íŠ¸
    koala.x += (koala.targetX - koala.x) * Math.min(1, 6*dt);

    // ì ì—…ë°ì´íŠ¸
    for (let i = leaves.length - 1; i >= 0; i--) {
      const lf = leaves[i];
      lf.y += lf.vy * dt;
      lf.x += Math.sin((lf.wobble += dt*6)) * 20 * dt;

      // ì¶©ëŒ
      if (collide(koala.x, koala.y, 54, lf.x, lf.y, lf.size * 0.6)) {
        score += POINT_PER_LEAF;
        leaves.splice(i,1);
        updateHUD();
        checkRewardThreshold();
        continue;
      }
      // ë°”ë‹¥ ì§€ë‚˜ì¹˜ë©´ ì œê±° + miss ì¦ê°€
      if (lf.y - lf.size > 520) {
        leaves.splice(i,1);
        misses += 1;
        updateHUD();
        if (misses >= 2) {
          gameOver();
          return;
        }
      }
    }

    // ê·¸ë¦¬ê¸°
    ctx.clearRect(0,0,900,520);
    if (IMG_BG.complete) ctx.drawImage(IMG_BG, 0, 0, 900, 520);
    else { ctx.fillStyle = '#d7f0d8'; ctx.fillRect(0,0,900,520); }

    for (const lf of leaves) {
      ctx.save();
      ctx.translate(lf.x, lf.y);
      ctx.rotate(Math.sin(lf.wobble) * 0.4);
      if (IMG_LEAF.complete) ctx.drawImage(IMG_LEAF, -lf.size/2, -lf.size/2, lf.size, lf.size);
      else {
        ctx.fillStyle = '#2ea44f';
        ctx.beginPath(); ctx.ellipse(0,0,lf.size/2,lf.size/3,0,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }

    if (IMG_KOKO.complete) ctx.drawImage(IMG_KOKO, koala.x - koala.w/2, koala.y - koala.h/2, koala.w, koala.h);
    else {
      ctx.fillStyle='#9aa2b0';
      ctx.beginPath(); ctx.arc(koala.x, koala.y, 60,0,2*Math.PI); ctx.fill();
    }

    requestAnimationFrame(loop);
  }

  // ë³´ìƒ ì„ê³„ê°’ ì²´í¬ (í•œ ë²ˆë§Œ ë³´ìƒ ìš”êµ¬)
  function checkRewardThreshold() {
    const currentThreshold = Math.floor(score / CONVERSION_RATE);
    if (currentThreshold > lastRewardedThreshold) {
      // ìƒˆë¡œ í´ë ˆì„ ê°€ëŠ¥í•œ ë‹¨ê³„ì— ë„ë‹¬
      lastRewardedThreshold = currentThreshold;
      // ì•Œë¦¼ ë˜ëŠ” ìë™ í´ë ˆì„ ì‹œë„
      // ì—¬ê¸°ì„œëŠ” ìë™ìœ¼ë¡œ claim ë²„íŠ¼ì„ í™œì„±í™” (ë²„íŠ¼ì€ ì´ë¯¸ í™œì„±í™”ë¨)
      // ê·¸ë¦¬ê³  ì‚¬ìš©ìì—ê²Œ íŒì—… ì•ˆë‚´
      alert(`${currentThreshold * KOKO_PER_THRESHOLD} COCOë¥¼ í´ë ˆì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! "Claim KOKO" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìš”ì²­í•˜ì„¸ìš”.`);
    }
  }

  // Phantom ì—°ê²°
  connectBtn.addEventListener('click', async () => {
    if (!window.solana) {
      alert('Phantomì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë°”ì¼ì—ì„œëŠ” Phantom ì•± ë‚´ ë¸Œë¼ìš°ì €ë¡œ ì´ í˜ì´ì§€ë¥¼ ì—¬ì„¸ìš”.');
      return;
    }
    try {
      const resp = await window.solana.connect();
      connected = true;
      connectBtn.innerText = 'Connected âœ“';
      connectBtn.disabled = true;
      buyBtn.disabled = false;
      claimBtn.disabled = !(score >= CONVERSION_RATE);
      addrEl.innerText = 'ì§€ê°‘: ' + (window.solana.publicKey ? window.solana.publicKey.toString() : (resp?.publicKey?.toString()||'ì—°ê²°ë¨'));
    } catch (err) {
      console.error(err);
      alert('ì§€ê°‘ ì—°ê²° ì·¨ì†Œë¨');
    }
  });

  // ì•„ì´í…œ êµ¬ë§¤: ì‚¬ìš©ìì˜ ì§€ê°‘ì—ì„œ íŒë§¤ì ì£¼ì†Œë¡œ SOL ì „ì†¡
  buyBtn.addEventListener('click', async () => {
    if (!connected || !window.solana) { alert('ì§€ê°‘ì„ ì—°ê²°í•˜ì„¸ìš”'); return; }
    try {
      const publicKey = window.solana.publicKey;
      if (!publicKey) throw new Error('Public key ì—†ìŒ');

      // web3 ì‚¬ìš©: window.solana.signAndSendTransaction expects a solanaWeb3.Transaction
      // solanaWeb3ëŠ” <script src="https://unpkg.com/@solana/web3.js/...">ë¡œ ë¡œë“œë˜ì–´ì•¼ í•¨ (í•˜ë‹¨ì— ë¡œë“œ)
      const lamports = Math.round(ITEM_PRICE_SOL * 1e9);
      const toPubkey = new solanaWeb3.PublicKey(SELLER_ADDRESS);
      const tx = new solanaWeb3.Transaction().add(
        solanaWeb3.SystemProgram.transfer({
          fromPubkey: publicKey,
          toPubkey,
          lamports
        })
      );

      // ìµœê·¼ ë¸”ë¡í•´ì‹œ í•„ìš”
      tx.feePayer = publicKey;
      const { blockhash } = await (new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'))).getLatestBlockhash();
      tx.recentBlockhash = blockhash;

      const signedTx = await window.solana.signTransaction(tx);
      const raw = signedTx.serialize();
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const signature = await connection.sendRawTransaction(raw);
      await connection.confirmTransaction(signature, 'confirmed');

      alert('ì•„ì´í…œ êµ¬ë§¤ ì™„ë£Œ! tx: ' + signature);
    } catch (err) {
      console.error(err);
      alert('êµ¬ë§¤ ì‹¤íŒ¨: ' + (err?.message || err));
    }
  });

  // ì½”ì½” í´ë ˆì„: í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì„œëª… ìƒì„± -> ì„œë²„ ì œì¶œ ë˜ëŠ” ìˆ˜ë™ ì œì¶œ
  claimBtn.addEventListener('click', async () => {
    if (!connected || !window.solana) { alert('ì§€ê°‘ì„ ì—°ê²°í•˜ì„¸ìš”'); return; }
    try {
      const publicKey = window.solana.publicKey?.toString();
      const cocoAmount = Math.floor(score / CONVERSION_RATE) * KOKO_PER_THRESHOLD;
      if (cocoAmount <= 0) { alert('êµí™˜ ê°€ëŠ¥í•œ COCOê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

      // ë©”ì‹œì§€ ë‚´ìš©: ìš´ì˜ìê°€ ê²€ì¦í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¡œ êµ¬ì„±
      const msg = `KokoLeafClaim\naddress=${publicKey}\nscore=${score}\nCOCO=${cocoAmount}\ntime=${new Date().toISOString()}`;

      const encoded = new TextEncoder().encode(msg);
      // Phantom signMessage (utf8)
      const signed = await window.solana.signMessage(encoded, 'utf8');
      const sigArr = signed?.signature || signed;
      const sigU8 = sigArr instanceof Uint8Array ? sigArr : new Uint8Array(sigArr);
      const base64 = btoa(String.fromCharCode(...sigU8));

      // ê¸°ë³¸ ë™ì‘: ì„œëª… ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ê³ (ë³µì‚¬/ì „ì†¡), ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆìœ¼ë©´ ìë™ POST
      const resultObj = {
        publicKey,
        score,
        cocoAmount,
        message: msg,
        signature: base64
      };

      if (REWARD_SERVER_ENDPOINT) {
        try {
          const resp = await fetch(REWARD_SERVER_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(resultObj)
          });
          if (!resp.ok) throw new Error('Server responded ' + resp.status);
          const j = await resp.json();
          alert('í´ë ˆì„ ìš”ì²­ ì „ì†¡ ì™„ë£Œ: ' + JSON.stringify(j));
        } catch (err) {
          console.warn('ì„œë²„ ì „ì†¡ ì‹¤íŒ¨', err);
          // fallback: ì„œëª… ë³´ì—¬ì£¼ê¸°
          copyToClipboard(JSON.stringify(resultObj));
          alert('ì„œë²„ ì „ì†¡ ì‹¤íŒ¨. í´ë ˆì„ ì •ë³´ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ìš´ì˜ìì—ê²Œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
        }
      } else {
        // ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ìœ¼ë©´ ì„œëª… ì •ë³´ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤Œ(ë³µì‚¬)
        copyToClipboard(JSON.stringify(resultObj));
        alert('í´ë ˆì„ ì„œëª…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í´ë ˆì„ ì •ë³´ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ìš´ì˜ì(ë˜ëŠ” ì„œë²„)ì— ì œì¶œí•˜ë©´ COCO í† í°ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.');
      }

      // í´ë ˆì„ í›„, ì¤‘ë³µ í´ë ˆì„ ë°©ì§€í•˜ë ¤ë©´ lastRewardedThreshold ì—…ë°ì´íŠ¸
      lastRewardedThreshold = Math.floor(score / CONVERSION_RATE);
      updateHUD();
    } catch (err) {
      console.error(err);
      alert('í´ë ˆì„ ì„œëª… ì‹¤íŒ¨: ' + (err?.message || err));
    }
  });

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(()=>{ fallbackCopy(text); });
    } else {
      fallbackCopy(text);
    }
  }
  function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }

  // ì´ˆê¸° HUD & ë£¨í”„ ì‹œì‘
  updateHUD();
  lastTime = performance.now();
  requestAnimationFrame(loop);

})();
</script>

<!-- Solana web3 (ë¸Œë¼ìš°ì € ê¸€ë¡œë²Œ solanaWeb3 ì œê³µ) -->
<script src="https://unpkg.com/@solana/web3.js@1.76.1/lib/index.iife.js"></script>

</body>
</html>
